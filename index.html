<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Emulation's Proxy</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTUiIGZpbGw9IiMwMDAwMDAiLz48cGF0aCBkPSJNMTUgMzJBMTcgMTcgMCAwIDEgMzIgMTVBMjAgMjAgMCAwIDEgNDkgMzJBMTcgMTcgMCAwIDEgMzIgNDlBMjAgMjAgMCAwIDEgMTUgMzJaIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmI1MDAiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLW9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0xMCAzMkEyMiAyMiAwIDAgMSAzMiAxMEEyNSAyNSAwIDAgMSA1NCAzMkEyMiAyMiAwIDAgMSAzMiA1NEEyNSAyNSAwIDAgMSAxMCAzMloiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2UtZGFzaGFycmF5PSIzLDMiLz48L3N2Zz4=">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      background: linear-gradient(180deg, #0a0a0a, #1a1a1a);
      overflow-x: hidden;
      color: #e5e7eb;
      margin: 0;
    }
    #particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -10;
    }
    #three-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -9;
      opacity: 0.6;
    }
    .control-panel {
      background: rgba(15, 15, 15, 0.95);
      border: 1px solid rgba(75, 108, 183, 0.4);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(75, 108, 183, 0.3);
    }
    .top-bar {
      background: linear-gradient(145deg, #1a1a3a, #0a0a1a);
      border-bottom: 2px solid rgba(75, 108, 183, 0.5);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      z-index: 20;
    }
    .tab {
      background: rgba(40, 40, 40, 0.85);
      border-radius: 8px;
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .tab:hover {
      background: rgba(75, 108, 183, 0.6);
      transform: translateY(-2px);
    }
    .tab.active {
      background: linear-gradient(145deg, #4b6cb7, #182848);
      box-shadow: 0 0 15px rgba(75, 108, 183, 0.8);
    }
    .tab.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(75, 108, 183, 0.4), transparent);
      animation: loadingGlow 1.2s infinite;
    }
    @keyframes loadingGlow {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .btn-cosmic {
      background: linear-gradient(145deg, #4b6cb7, #182848);
      box-shadow: 0 0 10px rgba(75, 108, 183, 0.8);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-cosmic:hover {
      box-shadow: 0 0 15px rgba(75, 108, 183, 1);
      transform: scale(1.05);
    }
    .error-message {
      background: rgba(255, 0, 0, 0.25);
      border: 1px solid #ff4d4d;
      animation: shake 0.3s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .notification {
      background: rgba(75, 108, 183, 0.9);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(75, 108, 183, 0.5);
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }
    .loader svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    .new-tab-content {
      background: radial-gradient(circle, rgba(75, 108, 183, 0.2), rgba(15, 15, 15, 0.9) 70%);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
    }
    .toggle-panel {
      background: rgba(15, 15, 15, 0.95);
      border: 1px solid rgba(75, 108, 183, 0.4);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    .typing-text {
      display: inline-block;
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #4b6cb7;
      animation: typing 3s steps(30, end) 1s 1 normal both, blink 0.5s step-end infinite;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink {
      from, to { border-color: transparent; }
      50% { border-color: #4b6cb7; }
    }
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 15px rgba(75, 108, 183, 0.5);
    }
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(15, 15, 15, 0.95), rgba(0, 0, 0, 0.98));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #loading-screen svg {
      animation: spin 1.5s linear infinite;
    }
    #loading-text {
      color: #9f7aea;
      font-size: 1.5rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="text-gray-200 min-h-screen flex flex-col">
  <div id="loading-screen">
    <svg width="80" height="80" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <circle cx="32" cy="32" r="30" fill="none" stroke="#4b6cb7" stroke-width="4" stroke-opacity="0.5"/>
      <circle cx="32" cy="32" r="30" fill="none" stroke="#9f7aea" stroke-width="4" stroke-dasharray="94" stroke-dashoffset="47">
        <animateTransform attributeName="transform" type="rotate" from="0 32 32" to="360 32 32" dur="1.5s" repeatCount="indefinite"/>
      </circle>
    </svg>
    <div id="loading-text">Loading Emulation's Proxy...</div>
  </div>
  <div id="particles-js"></div>
  <canvas id="three-canvas"></canvas>
  <div class="top-bar fixed top-0 left-0 w-full z-20">
    <div class="flex space-x-2">
      <div id="tabs" class="flex space-x-2" role="tablist"></div>
      <button id="newTabBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="New Tab"><i class="fas fa-plus"></i> New Tab</button>
    </div>
    <div class="flex space-x-2">
      <button id="settingsBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="Settings"><i class="fas fa-cog"></i></button>
      <button id="favoritesBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="Favorites"><i class="fas fa-star"></i></button>
      <button id="aboutBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="About"><i class="fas fa-info-circle"></i></button>
      <button id="particleViewBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="3D Particle View"><i class="fas fa-cubes"></i> 3D View</button>
    </div>
  </div>
  <div id="main-content" class="max-w-5xl mx-auto p-8 w-full mt-20 z-10">
    <h1 class="text-5xl font-extrabold mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTUiIGZpbGw9IiMwMDAwMDAiLz48cGF0aCBkPSJNMTUgMzJBMTcgMTcgMCAwIDEgMzIgMTVBMjAgMjAgMCAwIDEgNDkgMzJBMTcgMTcgMCAwIDEgMzIgNDlBMjAgMjAgMCAwIDEgMTUgMzJaIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmI1MDAiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLW9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0xMCAzMkEyMiAyMiAwIDAgMSAzMiAxMEEyNSAyNSAwIDAgMSA1NCAzMkEyMiAyMiAwIDAgMSAzMiA1NEEyNSAyNSAwIDAgMSAxMCAzMloiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2UtZGFzaGFycmF5PSIzLDMiLz48L3N2Zz4=" class="w-12 h-12 mr-2">
      Emulation's Proxy
    </h1>
    <div class="control-panel p-8 mb-8">
      <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
        <input 
          id="urlInput" 
          type="text" 
          placeholder="Enter URL (e.g., example.com)" 
          class="flex-1 border border-gray-600 p-3 rounded-lg bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200"
          aria-label="Enter URL"
        >
        <button id="submitBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Go"><i class="fas fa-play"></i> Go</button>
        <button id="fullscreenBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Full Screen"><i class="fas fa-expand"></i></button>
        <button id="addFavoriteBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Add to Favorites"><i class="fas fa-star"></i></button>
      </div>
      <div id="error" class="error-message hidden text-center mt-4 p-2 rounded-lg"></div>
      <div id="settingsPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-cog mr-2"></i> Settings</h2>
        <div class="space-y-4">
          <label class="flex items-center">
            <input id="cloakToggle" type="checkbox" class="mr-2">
            <span><i class="fas fa-mask mr-2"></i> Enable Tab Cloaking</span>
          </label>
          <select id="cloakPreset" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="">Custom</option>
            <option value="google">Google</option>
            <option value="wikipedia">Wikipedia</option>
            <option value="youtube">YouTube</option>
            <option value="classroom">Google Classroom</option>
          </select>
          <input id="cloakTitle" type="text" placeholder="Custom Page Title" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <input id="cloakFavicon" type="text" placeholder="Favicon URL" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <input id="panicUrl" type="text" placeholder="Panic Button URL" value="https://www.youtube.com/@Emulation12" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <button id="panicBtn" class="btn-cosmic text-white p-2 rounded-lg w-full"><i class="fas fa-ban mr-2"></i> Panic</button>
          <button id="cloakBtn" class="btn-cosmic text-white p-2 rounded-lg w-full"><i class="fas fa-eye-slash mr-2"></i> About:Blank</button>
          <select id="themeSelect" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="dark">Dark</option>
            <option value="starfield">Starfield</option>
          </select>
          <label class="block"><i class="fas fa-shapes mr-2"></i> Particle Effect</label>
          <select id="particleType" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="circle">Circle</option>
            <option value="star">Star</option>
            <option value="triangle">Triangle</option>
            <option value="edge">Edge</option>
          </select>
          <label class="block"><i class="fas fa-tachometer-alt mr-2"></i> Particle Density</label>
          <input id="particleDensity" type="range" min="50" max="300" value="120" class="w-full">
          <label class="block"><i class="fas fa-tachometer-alt mr-2"></i> Particle Speed</label>
          <input id="particleSpeed" type="range" min="2" max="15" value="4" class="w-full">
          <label class="block"><i class="fas fa-palette mr-2"></i> Particle Color</label>
          <input id="particleColor" type="color" value="#4b6cb7" class="w-full h-10 border border-gray-600 rounded-lg bg-gray-700">
          <label class="block"><i class="fas fa-adjust mr-2"></i> Background Opacity</label>
          <input id="bgOpacity" type="range" min="0.3" max="1" step="0.1" value="0.6" class="w-full">
          <label class="block"><i class="fas fa-bolt mr-2"></i> Animation Intensity</label>
          <input id="animIntensity" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full">
          <label class="block"><i class="fas fa-redo mr-2"></i> Proxy Retry Attempts</label>
          <input id="proxyRetries" type="number" min="1" max="5" value="2" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <label class="flex items-center">
            <input id="ambientSound" type="checkbox" class="mr-2">
            <span><i class="fas fa-volume-up mr-2"></i> Enable Ambient Sound</span>
          </label>
          <label class="block"><i class="fas fa-server mr-2"></i> Proxy Server</label>
          <select id="proxySelect" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="allorigins">AllOrigins</option>
            <option value="corsproxy">CORS Proxy</option>
          </select>
        </div>
      </div>
      <div id="favoritesPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-star mr-2"></i> Favorites</h2>
        <div id="favoritesList" class="space-y-2"></div>
      </div>
      <div id="aboutPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-info-circle mr-2"></i> About</h2>
        <div class="space-y-4 text-gray-300">
          <p><strong>Emulation's Proxy</strong> is a cosmic-themed proxy website for seamless web access.</p>
          <ul class="list-disc pl-5">
            <li><strong>Proxy Access</strong>: Load websites via proxies by entering a URL.</li>
            <li><strong>Tab Cloaking</strong>: Disguise page title and favicon (Settings).</li>
            <li><strong>Panic Button</strong>: Redirect to a safe URL via Panic or Escape key.</li>
            <li><strong>Visuals</strong>: Enjoy Three.js animations and particle effects.</li>
            <li><strong>3D View</strong>: Fly through a 3D particle field with WASD and mouse controls.</li>
            <li><strong>Themes</strong>: Switch between Dark and Starfield themes.</li>
            <li><strong>Ambient Sound</strong>: Toggle space-themed audio.</li>
            <li><strong>Socials</strong>: <a href="https://www.youtube.com/@Emulation12" target="_blank" class="text-blue-400 hover:underline"><i class="fab fa-youtube mr-1"></i> YouTube (@Emulation12)</a>.</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="relative rounded-lg overflow-hidden">
      <div id="loader" class="loader">
        <svg width="64" height="64" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
          <circle cx="22" cy="22" r="20" fill="none" stroke="#4b6cb7" stroke-opacity=".3" stroke-width="2"/>
          <circle cx="22" cy="22" r="20" fill="none" stroke="#9f7aea" stroke-dasharray="90" stroke-dashoffset="60" stroke-width="2">
            <animateTransform attributeName="transform" type="rotate" from="0 22 22" to="360 22 22" dur="1s" repeatCount="indefinite"/>
          </circle>
        </svg>
      </div>
      <iframe id="contentFrame" class="w-full h-[700px] border-0"></iframe>
    </div>
    <div id="notification" class="notification hidden fixed bottom-4 right-4 p-4 text-white"></div>
  </div>
  <audio id="ambientAudio" preload="auto" loop>
    
  </audio>
  <script>
    // Sanitize input
    function sanitize(str) {
      return DOMPurify.sanitize(str, { USE_PROFILES: { html: true } });
    }

    // Loading screen
    const loadingScreen = document.getElementById('loading-screen');
    window.addEventListener('load', () => {
      setTimeout(() => loadingScreen.classList.add('hidden'), 1000);
    });

    // Particles.js
    let particlesConfigCache = null;
    function initParticles(theme, density = 120, speed = 4, type = 'circle', color = '#4b6cb7') {
      if (particlesConfigCache?.theme === theme && particlesConfigCache.density === density && particlesConfigCache.speed === speed && particlesConfigCache.type === type && particlesConfigCache.color === color) return;
      const baseConfig = {
        particles: {
          number: { value: density, density: { enable: true, value_area: 1000 } },
          color: { value: color },
          shape: { type },
          opacity: { value: 0.6, random: true },
          size: { value: 3, random: true },
          line_linked: { enable: true, distance: 100, color, opacity: 0.4, width: 1 },
          move: { enable: true, speed, direction: 'none', random: true }
        },
        interactivity: {
          detect_on: 'canvas',
          events: { onhover: { enable: true, mode: 'grab' }, onclick: { enable: true, mode: 'push' } },
          modes: { grab: { distance: 150, line_linked: { opacity: 0.7 } }, push: { particles_nb: 4 } }
        },
        retina_detect: true
      };
      const configs = {
        dark: baseConfig,
        starfield: {
          ...baseConfig,
          particles: { ...baseConfig.particles, opacity: { value: 0.8 }, size: { value: 2 }, line_linked: { enable: false }, move: { direction: 'random' } }
        }
      };
      particlesJS('particles-js', configs[theme] || baseConfig);
      particlesConfigCache = { theme, density, speed, type, color };
    }

    // Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.position.z = 50;

    // Nebula background
    const nebulaGeometry = new THREE.SphereGeometry(100, 16, 16);
    const nebulaShader = {
      vertexShader: `
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        varying vec2 vUv;
        uniform float time;
        void main() {
          vec2 uv = vUv * 2.0 - 1.0;
          float d = length(uv);
          vec3 color = mix(vec3(0.29, 0.42, 0.71), vec3(0.62, 0.47, 0.92), sin(d * 3.0 + time) * 0.5 + 0.5);
          gl_FragColor = vec4(color, 0.3);
        }
      `,
      uniforms: { time: { value: 0 } }
    };
    const nebulaMaterial = new THREE.ShaderMaterial({ ...nebulaShader, side: THREE.BackSide, transparent: true });
    const nebula = new THREE.Mesh(nebulaGeometry, nebulaMaterial);
    scene.add(nebula);

    // 3D Star-like particle field
    const particleCount = 5000;
    const starGeometry = new THREE.BufferGeometry();
    const starPositions = new Float32Array(particleCount * 3);
    const starVelocities = new Float32Array(particleCount * 3);
    const starColors = new Float32Array(particleCount * 3);
    const starSizes = new Float32Array(particleCount);
    const colors = [0x4b6cb7, 0x9f7aea, 0xff6b6b, 0x00cc99, 0xffffff];
    for (let i = 0; i < particleCount; i++) {
      starPositions[i * 3] = (Math.random() - 0.5) * 200;
      starPositions[i * 3 + 1] = (Math.random() - 0.5) * 200;
      starPositions[i * 3 + 2] = (Math.random() - 0.5) * 200;
      starVelocities[i * 3] = (Math.random() - 0.5) * 0.1;
      starVelocities[i * 3 + 1] = (Math.random() - 0.5) * 0.1;
      starVelocities[i * 3 + 2] = (Math.random() - 0.5) * 0.1;
      const color = new THREE.Color(colors[Math.floor(Math.random() * colors.length)]);
      starColors[i * 3] = color.r;
      starColors[i * 3 + 1] = color.g;
      starColors[i * 3 + 2] = color.b;
      starSizes[i] = 2 + Math.random() * 3;
    }
    starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
    starGeometry.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
    starGeometry.setAttribute('size', new THREE.BufferAttribute(starSizes, 1));
    const starShader = {
      vertexShader: `
        attribute float size;
        varying vec3 vColor;
        void main() {
          vColor = color;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          gl_PointSize = size;
        }
      `,
      fragmentShader: `
        varying vec3 vColor;
        uniform float time;
        void main() {
          float glow = 0.8 + 0.2 * sin(time * 2.0);
          gl_FragColor = vec4(vColor, glow);
        }
      `,
      uniforms: { time: { value: 0 } }
    };
    const starMaterial = new THREE.ShaderMaterial({ ...starShader, transparent: true, vertexColors: true });
    const stars = new THREE.Points(starGeometry, starMaterial);
    let particleViewActive = false;

    // Fly controls
    const moveSpeed = 0.5;
    const lookSpeed = 0.002;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false;
    let yaw = 0, pitch = 0;
    document.addEventListener('keydown', (e) => {
      if (!particleViewActive) return;
      switch (e.key.toLowerCase()) {
        case 'w': moveForward = true; break;
        case 's': moveBackward = true; break;
        case 'a': moveLeft = true; break;
        case 'd': moveRight = true; break;
        case 'r': moveUp = true; break;
        case 'f': moveDown = true; break;
        case 'escape': particleViewBtn.click(); break;
      }
    });
    document.addEventListener('keyup', (e) => {
      if (!particleViewActive) return;
      switch (e.key.toLowerCase()) {
        case 'w': moveForward = false; break;
        case 's': moveBackward = false; break;
        case 'a': moveLeft = false; break;
        case 'd': moveRight = false; break;
        case 'r': moveUp = false; break;
        case 'f': moveDown = false; break;
      }
    });
    let mouseX = 0, mouseY = 0;
    document.addEventListener('mousemove', (e) => {
      if (!particleViewActive) return;
      mouseX = e.movementX * lookSpeed;
      mouseY = e.movementY * lookSpeed;
    });

    // Pointer Lock
    function lockPointer() {
      const canvas = document.getElementById('three-canvas');
      canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock || canvas.webkitRequestPointerLock;
      canvas.requestPointerLock?.();
    }
    document.addEventListener('pointerlockchange', () => {
      particleViewActive = document.pointerLockElement === document.getElementById('three-canvas');
      if (!particleViewActive) {
        scene.remove(stars);
        document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
        mainContent.classList.remove('hidden');
        document.querySelector('.top-bar').classList.remove('hidden');
        contentFrame.classList.remove('hidden');
        particleViewBtn.innerHTML = '<i class="fas fa-cubes"></i> 3D View';
        const activeTab = tabs.find(t => t.id === tabsDiv.dataset.active);
        contentFrame.srcdoc = activeTab ? activeTab.content : '';
      }
    });
    document.addEventListener('mozpointerlockchange', () => {
      particleViewActive = document.mozPointerLockElement === document.getElementById('three-canvas');
      if (!particleViewActive) {
        scene.remove(stars);
        document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
        mainContent.classList.remove('hidden');
        document.querySelector('.top-bar').classList.remove('hidden');
        contentFrame.classList.remove('hidden');
        particleViewBtn.innerHTML = '<i class="fas fa-cubes"></i> 3D View';
        const activeTab = tabs.find(t => t.id === tabsDiv.dataset.active);
        contentFrame.srcdoc = activeTab ? activeTab.content : '';
      }
    });

    // Animation loop
    function animateThree() {
      requestAnimationFrame(animateThree);
      nebulaShader.uniforms.time.value += 0.01;
      starShader.uniforms.time.value += 0.01;
      if (particleViewActive) {
        for (let i = 0; i < particleCount; i++) {
          starPositions[i * 3] += starVelocities[i * 3];
          starPositions[i * 3 + 1] += starVelocities[i * 3 + 1];
          starPositions[i * 3 + 2] += starVelocities[i * 3 + 2];
          if (Math.abs(starPositions[i * 3]) > 100) starPositions[i * 3] = -Math.sign(starPositions[i * 3]) * 100;
          if (Math.abs(starPositions[i * 3 + 1]) > 100) starPositions[i * 3 + 1] = -Math.sign(starPositions[i * 3 + 1]) * 100;
          if (Math.abs(starPositions[i * 3 + 2]) > 100) starPositions[i * 3 + 2] = -Math.sign(starPositions[i * 3 + 2]) * 100;
        }
        starGeometry.attributes.position.needsUpdate = true;
        yaw -= mouseX;
        pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch - mouseY));
        camera.rotation.set(pitch, yaw, 0);
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);
        if (moveForward) camera.position.addScaledVector(direction, moveSpeed);
        if (moveBackward) camera.position.addScaledVector(direction, -moveSpeed);
        if (moveLeft) camera.position.addScaledVector(direction.cross(new THREE.Vector3(0, 1, 0)), -moveSpeed);
        if (moveRight) camera.position.addScaledVector(direction.cross(new THREE.Vector3(0, 1, 0)), moveSpeed);
        if (moveUp) camera.position.y += moveSpeed;
        if (moveDown) camera.position.y -= moveSpeed;
      }
      renderer.render(scene, camera);
    }
    animateThree();

    // Resize handler
    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });

    // DOM elements
    const urlInput = document.getElementById('urlInput');
    const submitBtn = document.getElementById('submitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const addFavoriteBtn = document.getElementById('addFavoriteBtn');
    const cloakBtn = document.getElementById('cloakBtn');
    const panicBtn = document.getElementById('panicBtn');
    const errorDiv = document.getElementById('error');
    const contentFrame = document.getElementById('contentFrame');
    const tabsDiv = document.getElementById('tabs');
    const settingsPanel = document.getElementById('settingsPanel');
    const favoritesPanel = document.getElementById('favoritesPanel');
    const aboutPanel = document.getElementById('aboutPanel');
    const settingsBtn = document.getElementById('settingsBtn');
    const favoritesBtn = document.getElementById('favoritesBtn');
    const aboutBtn = document.getElementById('aboutBtn');
    const particleViewBtn = document.getElementById('particleViewBtn');
    const newTabBtn = document.getElementById('newTabBtn');
    const cloakToggle = document.getElementById('cloakToggle');
    const cloakTitle = document.getElementById('cloakTitle');
    const cloakFavicon = document.getElementById('cloakFavicon');
    const cloakPreset = document.getElementById('cloakPreset');
    const panicUrlInput = document.getElementById('panicUrl');
    const themeSelect = document.getElementById('themeSelect');
    const particleDensity = document.getElementById('particleDensity');
    const particleSpeed = document.getElementById('particleSpeed');
    const particleType = document.getElementById('particleType');
    const particleColor = document.getElementById('particleColor');
    const bgOpacity = document.getElementById('bgOpacity');
    const animIntensity = document.getElementById('animIntensity');
    const proxyRetries = document.getElementById('proxyRetries');
    const proxySelect = document.getElementById('proxySelect');
    const notification = document.getElementById('notification');
    const ambientAudio = document.getElementById('ambientAudio');
    const loader = document.getElementById('loader');
    const mainContent = document.getElementById('main-content');
    let tabs = JSON.parse(localStorage.getItem('tabs')) || [
      { id: 'new-tab', url: null, content: `
        <div class="new-tab-content">
          <h2 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 typing-text">Welcome to Emulation's Proxy</h2>
          <p class="text-lg mb-6 text-gray-300">Browse securely or fly through a 3D particle universe.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('urlInput').focus()">
              <i class="fas fa-globe text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Browse</h3>
              <p class="text-gray-400">Access websites via proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('favoritesBtn').click()">
              <i class="fas fa-star text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Favorites</h3>
              <p class="text-gray-400">Save and revisit sites.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('settingsBtn').click()">
              <i class="fas fa-cog text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Settings</h3>
              <p class="text-gray-400">Customize themes and particles.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('particleViewBtn').click()">
              <i class="fas fa-cubes text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">3D View</h3>
              <p class="text-gray-400">Explore 3D particle field.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('aboutBtn').click()">
              <i class="fas fa-info-circle text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">About</h3>
              <p class="text-gray-400">Learn about Emulation's Proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('panicBtn').click()">
              <i class="fas fa-ban text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Panic</h3>
              <p class="text-gray-400">Redirect to a safe URL.</p>
            </div>
          </div>
        </div>`, label: 'New Tab', type: 'new-tab', icon: 'fas fa-home' }
    ];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

    // Theme management
    function applyTheme(theme) {
      document.body.style.background = theme === 'dark' ? 'linear-gradient(180deg, #0a0a0a, #1a1a1a)' : 'linear-gradient(180deg, #000000, #0a0a1a)';
      document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
      gsap.to('.btn-cosmic, .control-panel, .tab.active', { animationDuration: parseFloat(animIntensity.value) * 1.5, duration: 0.3 });
      initParticles(theme, parseInt(particleDensity.value), parseInt(particleSpeed.value), particleType.value, particleColor.value);
    }
    themeSelect.addEventListener('change', () => applyTheme(themeSelect.value));
    particleDensity.addEventListener('input', () => applyTheme(themeSelect.value));
    particleSpeed.addEventListener('input', () => applyTheme(themeSelect.value));
    particleType.addEventListener('change', () => applyTheme(themeSelect.value));
    particleColor.addEventListener('input', () => applyTheme(themeSelect.value));
    bgOpacity.addEventListener('input', () => applyTheme(themeSelect.value));
    animIntensity.addEventListener('input', () => applyTheme(themeSelect.value));
    applyTheme('dark');

    // Ambient sound
    let audioLoaded = false;
    document.getElementById('ambientSound').addEventListener('change', (e) => {
      if (!audioLoaded) {
        ambientAudio.load();
        audioLoaded = true;
      }
      if (e.target.checked) {
        ambientAudio.play().catch(err => {
          errorDiv.textContent = `Audio error: ${err.message}`;
          errorDiv.classList.remove('hidden');
          gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
          document.getElementById('ambientSound').checked = false;
        });
      } else {
        ambientAudio.pause();
      }
    });
    document.addEventListener('click', () => {
      if (document.getElementById('ambientSound').checked && !audioLoaded) {
        ambientAudio.load();
        audioLoaded = true;
        ambientAudio.play().catch(() => {});
      }
    }, { once: true });

    // Tab cloaking
    const cloakPresets = {
      google: { title: 'Google', favicon: 'https://www.google.com/favicon.ico' },
      wikipedia: { title: 'Wikipedia', favicon: 'https://en.wikipedia.org/favicon.ico' },
      youtube: { title: 'YouTube', favicon: 'https://www.youtube.com/favicon.ico' },
      classroom: { title: 'Google Classroom', favicon: 'https://classroom.google.com/favicon.ico' }
    };
    function updateCloaking() {
      if (cloakToggle.checked) {
        const preset = cloakPreset.value;
        if (preset && cloakPresets[preset]) {
          document.getElementById('pageTitle').textContent = cloakPresets[preset].title;
          document.getElementById('favicon').href = cloakPresets[preset].favicon;
          cloakTitle.value = cloakPresets[preset].title;
          cloakFavicon.value = cloakPresets[preset].favicon;
        } else {
          document.getElementById('pageTitle').textContent = cloakTitle.value || "Emulation's Proxy";
          document.getElementById('favicon').href = cloakFavicon.value || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTUiIGZpbGw9IiMwMDAwMDAiLz48cGF0aCBkPSJNMTUgMzJBMTcgMTcgMCAwIDEgMzIgMTVBMjAgMjAgMCAwIDEgNDkgMzJBMTcgMTcgMCAwIDEgMzIgNDlBMjAgMjAgMCAwIDEgMTUgMzJaIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmI1MDAiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLW9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0xMCAzMkEyMiAyMiAwIDAgMSAzMiAxMEEyNSAyNSAwIDAgMSA1NCAzMkEyMiAyMiAwIDAgMSAzMiA1NEEyNSAyNSAwIDAgMSAxMCAzMloiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2UtZGFzaGFycmF5PSIzLDMiLz48L3N2Zz4=';
        }
      } else {
        document.getElementById('pageTitle').textContent = "Emulation's Proxy";
        document.getElementById('favicon').href = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTUiIGZpbGw9IiMwMDAwMDAiLz48cGF0aCBkPSJNMTUgMzJBMTcgMTcgMCAwIDEgMzIgMTVBMjAgMjAgMCAwIDEgNDkgMzJBMTcgMTcgMCAwIDEgMzIgNDlBMjAgMjAgMCAwIDEgMTUgMzJaIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmI1MDAiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLW9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0xMCAzMkEyMiAyMiAwIDAgMSAzMiAxMEEyNSAyNSAwIDAgMSA1NCAzMkEyMiAyMiAwIDAgMSAzMiA1NEEyNSAyNSAwIDAgMSAxMCAzMloiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2UtZGFzaGFycmF5PSIzLDMiLz48L3N2Zz4=';
      }
    }
    cloakToggle.addEventListener('change', updateCloaking);
    cloakTitle.addEventListener('input', () => { cloakPreset.value = ''; updateCloaking(); });
    cloakFavicon.addEventListener('input', () => { cloakPreset.value = ''; updateCloaking(); });
    cloakPreset.addEventListener('change', updateCloaking);

    // Toggle panels
    function togglePanel(panel) {
      const isHidden = panel.classList.contains('hidden');
      [settingsPanel, favoritesPanel, aboutPanel].forEach(p => p.classList.add('hidden'));
      if (isHidden) {
        panel.classList.remove('hidden');
        gsap.fromTo(panel, { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.3 });
      }
    }
    settingsBtn.addEventListener('click', () => togglePanel(settingsPanel));
    favoritesBtn.addEventListener('click', () => togglePanel(favoritesPanel));
    aboutBtn.addEventListener('click', () => togglePanel(aboutPanel));

    // 3D Particle view toggle
    particleViewBtn.addEventListener('click', () => {
      particleViewActive = !particleViewActive;
      if (particleViewActive) {
        scene.add(stars);
        document.querySelector('#three-canvas').style.opacity = 1;
        mainContent.classList.add('hidden');
        document.querySelector('.top-bar').classList.add('hidden');
        lockPointer();
        particleViewBtn.innerHTML = '<i class="fas fa-times"></i> Exit 3D View';
        Swal.fire({ title: '3D Star Field', text: 'Use WASD, R/F, mouse, Esc to exit.', icon: 'info', timer: 2000, showConfirmButton: false, background: '#1a1a1a', color: '#fff' });
      } else {
        scene.remove(stars);
        document.exitPointerLock?.();
        document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
        mainContent.classList.remove('hidden');
        document.querySelector('.top-bar').classList.remove('hidden');
        contentFrame.classList.remove('hidden');
        particleViewBtn.innerHTML = '<i class="fas fa-cubes"></i> 3D View';
        const activeTab = tabs.find(t => t.id === tabsDiv.dataset.active);
        contentFrame.srcdoc = activeTab ? activeTab.content : '';
      }
    });

    // Favorites management
    function renderFavorites() {
      const favoritesList = document.getElementById('favoritesList');
      favoritesList.innerHTML = '';
      favorites.forEach((fav, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-gray-800 p-2 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center">
            <img src="https://www.google.com/s2/favicons?domain=${sanitize(fav.url)}" class="w-5 h-5 mr-2" alt="Favicon">
            <a href="#" class="text-blue-400 hover:underline" data-url="${sanitize(fav.url)}">${sanitize(fav.label)}</a>
          </div>
          <button class="text-red-400" data-index="${index}"><i class="fas fa-trash"></i></button>
        `;
        div.querySelector('a').addEventListener('click', (e) => {
          e.preventDefault();
          urlInput.value = fav.url;
          submitBtn.click();
        });
        div.querySelector('button').addEventListener('click', () => {
          favorites.splice(index, 1);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          renderFavorites();
        });
        favoritesList.appendChild(div);
      });
    }
    addFavoriteBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      if (url && !favorites.some(f => f.url === url)) {
        const hostname = new URL(url.match(/^https?:\/\//) ? url : 'https://' + url).hostname;
        favorites.push({ url, label: hostname });
        localStorage.setItem('favorites', JSON.stringify(favorites));
        renderFavorites();
        Swal.fire({ title: 'Added', text: `${sanitize(hostname)} saved`, icon: 'success', timer: 1500, showConfirmButton: false, background: '#1a1a1a', color: '#fff' });
      }
    });
    renderFavorites();

    // Tab management
    function addTab(id, url, content, label, type = 'proxy', icon = 'fas fa-globe') {
      tabs = tabs.filter(t => t.url !== url || t.type !== 'proxy');
      tabs.push({ id, url, content, label, type, icon });
      localStorage.setItem('tabs', JSON.stringify(tabs));
      renderTabs();
    }
    function renderTabs() {
      tabsDiv.innerHTML = '';
      tabs.forEach(tab => {
        const tabBtn = document.createElement('button');
        tabBtn.className = `tab text-gray-200 px-4 py-2 rounded-lg ${tab.id === tabsDiv.dataset.active ? 'active' : ''}`;
        tabBtn.setAttribute('role', 'tab');
        tabBtn.setAttribute('aria-selected', tab.id === tabsDiv.dataset.active);
        tabBtn.innerHTML = tab.icon.startsWith('<img') ? `${tab.icon}${sanitize(tab.label)}` : `<i class="${tab.icon} mr-2"></i>${sanitize(tab.label)}`;
        const closeBtn = document.createElement('span');
        closeBtn.textContent = ' ×';
        closeBtn.className = 'ml-2 text-red-400 cursor-pointer';
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          tabs = tabs.filter(t => t.id !== tab.id);
          localStorage.setItem('tabs', JSON.stringify(tabs));
          if (tab.id === tabsDiv.dataset.active) {
            tabsDiv.dataset.active = 'new-tab';
            contentFrame.srcdoc = tabs.find(t => t.id === 'new-tab').content;
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          }
          renderTabs();
        };
        tabBtn.appendChild(closeBtn);
        tabBtn.onclick = () => {
          tabsDiv.dataset.active = tab.id;
          document.getElementById('favicon').href = tab.icon.startsWith('<img') ? tab.icon.match(/src="([^"]+)"/)[1] : document.getElementById('favicon').href;
          if (tab.type === 'proxy' && tab.content) {
            contentFrame.srcdoc = tab.content;
            contentFrame.classList.remove('hidden');
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          } else if (tab.type === 'new-tab') {
            contentFrame.srcdoc = tab.content;
            contentFrame.classList.remove('hidden');
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          }
          renderTabs();
          anime({ targets: tabBtn, scale: [0.9, 1], duration: 300, easing: 'easeOutQuad' });
        };
        tabsDiv.appendChild(tabBtn);
      });
    }
    tabsDiv.dataset.active = 'new-tab';
    contentFrame.srcdoc = tabs.find(t => t.id === 'new-tab').content;
    renderTabs();

    // New tab
    newTabBtn.addEventListener('click', () => {
      addTab(Date.now().toString(), null, `
        <div class="new-tab-content">
          <h2 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 typing-text">Welcome to Emulation's Proxy</h2>
          <p class="text-lg mb-6 text-gray-300">Browse securely or fly through a 3D particle universe.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('urlInput').focus()">
              <i class="fas fa-globe text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Browse</h3>
              <p class="text-gray-400">Access websites via proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('favoritesBtn').click()">
              <i class="fas fa-star text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Favorites</h3>
              <p class="text-gray-400">Save and revisit sites.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('settingsBtn').click()">
              <i class="fas fa-cog text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Settings</h3>
              <p class="text-gray-400">Customize themes and particles.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('particleViewBtn').click()">
              <i class="fas fa-cubes text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">3D View</h3>
              <p class="text-gray-400">Explore 3D particle field.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('aboutBtn').click()">
              <i class="fas fa-info-circle text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">About</h3>
              <p class="text-gray-400">Learn about Emulation's Proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('panicBtn').click()">
              <i class="fas fa-ban text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Panic</h3>
              <p class="text-gray-400">Redirect to a safe URL.</p>
            </div>
          </div>
        </div>`, 'New Tab', 'new-tab', 'fas fa-home');
      tabsDiv.dataset.active = Date.now().toString();
      renderTabs();
    });

    // About:Blank
    cloakBtn.addEventListener('click', () => {
      try {
        const currentContent = encodeURIComponent(contentFrame.srcdoc || '');
        if (currentContent) {
          const cloakFrame = document.createElement('iframe');
          cloakFrame.srcdoc = `
            <!DOCTYPE html>
            <html>
              <head><title>${sanitize(cloakToggle.checked ? cloakTitle.value : "Emulation's Proxy")}</title></head>
              <body style="margin:0;overflow:hidden;">
                <iframe srcdoc="${currentContent}" style="width:100%;height:100vh;border:0;"></iframe>
              </body>
            </html>
          `;
          cloakFrame.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;border:0;z-index:1000;';
          document.body.appendChild(cloakFrame);
          Swal.fire({ title: 'Success', text: 'Opened in About:Blank', icon: 'success', timer: 1500, showConfirmButton: false, background: '#1a1a1a', color: '#fff' });
        } else {
          errorDiv.textContent = 'No content to cloak';
          errorDiv.classList.remove('hidden');
          gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        }
      } catch (err) {
        errorDiv.textContent = `Cloak error: ${err.message}`;
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
      }
    });

    // Panic button
    function triggerPanic() {
      window.location.href = panicUrlInput.value || 'https://www.youtube.com/@Emulation12';
    }
    panicBtn.addEventListener('click', triggerPanic);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !particleViewActive) triggerPanic();
    });

    // Full screen
    fullscreenBtn.addEventListener('click', () => {
      if (contentFrame.requestFullscreen) contentFrame.requestFullscreen();
      else if (contentFrame.webkitRequestFullscreen) contentFrame.webkitRequestFullscreen();
      else if (contentFrame.msRequestFullscreen) contentFrame.msRequestFullscreen();
      Swal.fire({ title: 'Full Screen', text: 'Entered full-screen mode', icon: 'info', timer: 1500, showConfirmButton: false, background: '#1a1a1a', color: '#fff' });
    });

    // Proxy request
    async function fetchWithRetries(url, retries) {
      const proxyUrls = {
        allorigins: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        corsproxy: `https://corsproxy.io/?${encodeURIComponent(url)}`
      };
      const selectedProxy = proxySelect.value;
      for (let i = 0; i < retries; i++) {
        try {
          loadingScreen.classList.remove('hidden');
          const response = await fetch(proxyUrls[selectedProxy]);
          if (response.ok) return response;
          if (response.status === 429) throw new Error('Rate limit exceeded.');
          throw new Error(`HTTP error ${response.status}`);
        } catch (err) {
          if (i === retries - 1) throw err;
        } finally {
          loadingScreen.classList.add('hidden');
        }
      }
    }
    submitBtn.addEventListener('click', async () => {
      let url = urlInput.value.trim();
      errorDiv.classList.add('hidden');
      contentFrame.classList.add('hidden');
      settingsPanel.classList.add('hidden');
      favoritesPanel.classList.add('hidden');
      aboutPanel.classList.add('hidden');
      loader.style.display = 'block';

      if (!url) {
        errorDiv.textContent = 'Enter a URL';
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        loader.style.display = 'none';
        return;
      }

      if (!url.match(/^https?:\/\//)) url = 'https://' + url;
      if (!url.match(/^https?:\/\/.+/)) {
        errorDiv.textContent = 'Invalid URL';
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        loader.style.display = 'none';
        return;
      }

      const hostname = new URL(url).hostname;
      notification.textContent = `Going to ${sanitize(hostname)}`;
      notification.classList.remove('hidden');
      gsap.fromTo(notification, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
      gsap.to(notification, { opacity: 0, delay: 2, duration: 0.5, onComplete: () => notification.classList.add('hidden') });

      const tabId = Date.now().toString();
      tabsDiv.dataset.active = tabId;
      const tabBtn = document.createElement('button');
      tabBtn.className = 'tab text-gray-200 px-4 py-2 rounded-lg loading';
      tabBtn.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${hostname}" class="w-5 h-5 mr-2" alt="Favicon">${sanitize(hostname)}`;
      tabsDiv.appendChild(tabBtn);
      anime({ targets: tabBtn, scale: [0.9, 1], duration: 300, easing: 'easeOutQuad' });

      try {
        const response = await fetchWithRetries(url, parseInt(proxyRetries.value));
        const data = await response.text();
        contentFrame.srcdoc = data;
        contentFrame.classList.remove('hidden');
        loader.style.display = 'none';
        addTab(tabId, url, data, hostname, 'proxy', `<img src="https://www.google.com/s2/favicons?domain=${hostname}" class="w-5 h-5 mr-2" alt="Favicon">`);
        renderTabs();
      } catch (err) {
        errorDiv.textContent = `Failed to load: ${err.message}`;
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        loader.style.display = 'none';
        tabs = tabs.filter(t => t.id !== tabId);
        tabsDiv.dataset.active = 'new-tab';
        contentFrame.srcdoc = tabs.find(t => t.id === 'new-tab').content;
        contentFrame.classList.remove('hidden');
        renderTabs();
      }
    });
  </script>
</body>
</html>
