<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Emulation's Proxy</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9ImdyYWRpZW50IiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM0YjZjYjciIHN0b3Atb3BhY2l0eT0iMSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzE4Mjg0OCIgc3RvcC1vcGFjaXR5PSIwLjUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48cGF0aCBkPSJNNDggNTBhMjAgMjAgMCAxIDAgMCA0MCAyMCAyMCAwIDAgMCAwIC00MFoiIGZpbGw9IiNmZmZiNmIiIHN0cm9rZT0iIzlmN2FlYSIgc3Ryb2tlLXdpZHRoPSIxLjUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik01MCA1MGEzMCAzMCAwIDAgMCA0MiA0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1kYXNoYXJyYXk9IjMsMyIgb3BhY2l0eT0iMC41Ii8+PHBhdGggZD0iTTYwIDUwYTUgNSAwIDEgMCAwIDEwIDUgNSAwIDAgMCAwIC0xMFoiIGZpbGw9IiM5ZjdhZWEiLz48L3N2Zz4=">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      background: linear-gradient(180deg, #0a0a0a, #1a1a1a);
      overflow-x: hidden;
      color: #e5e7eb;
    }
    #particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -10;
    }
    #three-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -9;
      opacity: 0.6;
    }
    .control-panel {
      background: rgba(15, 15, 15, 0.95);
      border: 1px solid rgba(75, 108, 183, 0.4);
      border-radius: 12px;
      box-shadow: 0 0 40px rgba(75, 108, 183, 0.3);
      animation: cosmicPulse 2s infinite ease-in-out;
    }
    .top-bar {
      background: linear-gradient(145deg, #1a1a3a, #0a0a1a);
      border-bottom: 2px solid rgba(75, 108, 183, 0.5);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
      border-radius: 0 0 12px 12px;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 20;
    }
    .tab {
      background: rgba(40, 40, 40, 0.85);
      border-radius: 8px;
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .tab:hover {
      background: rgba(75, 108, 183, 0.6);
      transform: translateY(-2px);
    }
    .tab.active {
      background: linear-gradient(145deg, #4b6cb7, #182848);
      box-shadow: 0 0 25px rgba(75, 108, 183, 0.8), 0 0 10px rgba(159, 122, 234, 0.5);
    }
    .tab.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(75, 108, 183, 0.4), transparent);
      animation: loadingGlow 1.2s infinite;
    }
    @keyframes loadingGlow {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .btn-cosmic {
      background: linear-gradient(145deg, #4b6cb7, #182848);
      box-shadow: 0 0 15px rgba(75, 108, 183, 0.8), 0 0 30px rgba(75, 108, 183, 0.4);
      transition: all 0.3s ease;
      animation: cosmicPulse 1.5s infinite ease-in-out;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-cosmic:hover {
      box-shadow: 0 0 25px rgba(75, 108, 183, 1), 0 0 40px rgba(75, 108, 183, 0.6);
      transform: scale(1.05);
    }
    @keyframes cosmicPulse {
      0% { box-shadow: 0 0 15px rgba(75, 108, 183, 0.8); }
      50% { box-shadow: 0 0 25px rgba(75, 108, 183, 0.4); }
      100% { box-shadow: 0 0 15px rgba(75, 108, 183, 0.8); }
    }
    .error-message {
      background: rgba(255, 0, 0, 0.25);
      border: 1px solid #ff4d4d;
      animation: shake 0.3s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .notification {
      background: rgba(75, 108, 183, 0.9);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(75, 108, 183, 0.5);
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }
    .loader svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    .new-tab-content {
      background: rgba(15, 15, 15, 0.9);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      animation: fadeIn 1s ease-out;
      position: relative;
      overflow: hidden;
    }
    .new-tab-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(75, 108, 183, 0.2), transparent 70%);
      z-index: -1;
    }
    @keyframes fadeIn {
      from { opacity: 0; scale: 0.95; }
      to { opacity: 1; scale: 1; }
    }
    .toggle-panel {
      background: rgba(15, 15, 15, 0.95);
      border: 1px solid rgba(75, 108, 183, 0.4);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    .typing-text {
      display: inline-block;
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #4b6cb7;
      animation: typing 3s steps(30, end) 1s 1 normal both, blink 0.5s step-end infinite;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink {
      from, to { border-color: transparent; }
      50% { border-color: #4b6cb7; }
    }
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 20px rgba(75, 108, 183, 0.5);
    }
  </style>
</head>
<body class="text-gray-200 min-h-screen flex flex-col">
  <div id="particles-js"></div>
  <canvas id="three-canvas"></canvas>
  <div class="top-bar fixed top-0 left-0 w-full z-20">
    <div class="flex space-x-2">
      <div id="tabs" class="flex space-x-2" role="tablist"></div>
      <button id="newTabBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="New Tab"><i class="fas fa-plus"></i> New Tab</button>
    </div>
    <div class="flex space-x-2">
      <button id="settingsBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="Settings"><i class="fas fa-cog"></i></button>
      <button id="favoritesBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="Favorites"><i class="fas fa-star"></i></button>
      <button id="aboutBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="About"><i class="fas fa-info-circle"></i></button>
      <button id="particleViewBtn" class="btn-cosmic text-white px-4 py-2 rounded-lg" aria-label="3D Particle View"><i class="fas fa-cubes"></i> 3D View</button>
    </div>
  </div>
  <div class="max-w-5xl mx-auto p-8 w-full mt-20 z-10">
    <h1 class="text-5xl font-extrabold mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9ImdyYWRpZW50IiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM0YjZjYjciIHN0b3Atb3BhY2l0eT0iMSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzE4Mjg0OCIgc3RvcC1vcGFjaXR5PSIwLjUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48cGF0aCBkPSJNNDggNTBhMjAgMjAgMCAxIDAgMCA0MCAyMCAyMCAwIDAgMCAwIC00MFoiIGZpbGw9IiNmZmZiNmIiIHN0cm9rZT0iIzlmN2FlYSIgc3Ryb2tlLXdpZHRoPSIxLjUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik01MCA1MGEzMCAzMCAwIDAgMCA0MiA0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1kYXNoYXJyYXk9IjMsMyIgb3BhY2l0eT0iMC41Ii8+PHBhdGggZD0iTTYwIDUwYTUgNSAwIDEgMCAwIDEwIDUgNSAwIDAgMCAwIC0xMFoiIGZpbGw9IiM5ZjdhZWEiLz48L3N2Zz4=" class="w-12 h-12 mr-2">
      Emulation's Proxy
    </h1>
    <div class="control-panel p-8 mb-8">
      <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
        <input 
          id="urlInput" 
          type="text" 
          placeholder="Enter URL (e.g., example.com)" 
          class="flex-1 border border-gray-600 p-3 rounded-lg bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200 placeholder-gray-400"
          aria-label="Enter URL"
        >
        <button id="submitBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Go"><i class="fas fa-play"></i> Go</button>
        <button id="fullscreenBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Full Screen"><i class="fas fa-expand"></i> Full Screen</button>
        <button id="addFavoriteBtn" class="btn-cosmic text-white p-3 rounded-lg" aria-label="Add to Favorites"><i class="fas fa-star"></i> Add to Favorites</button>
      </div>
      <div id="error" class="error-message hidden text-center mt-4 p-2 rounded-lg"></div>
      <div id="settingsPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-cog mr-2"></i> Settings</h2>
        <div class="space-y-4">
          <label class="flex items-center">
            <input id="cloakToggle" type="checkbox" class="mr-2">
            <span><i class="fas fa-mask mr-2"></i> Enable Tab Cloaking</span>
          </label>
          <input id="cloakTitle" type="text" placeholder="Custom Page Title" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <input id="cloakFavicon" type="text" placeholder="Favicon URL" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <input id="panicUrl" type="text" placeholder="Panic Button URL" value="https://www.youtube.com/@Emulation12" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <button id="panicBtn" class="btn-cosmic text-white p-2 rounded-lg w-full"><i class="fas fa-ban mr-2"></i> Trigger Panic</button>
          <button id="cloakBtn" class="btn-cosmic text-white p-2 rounded-lg w-full"><i class="fas fa-eye-slash mr-2"></i> Open in About:Blank</button>
          <select id="themeSelect" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="dark">Dark</option>
            <option value="nebula">Nebula</option>
            <option value="starfield">Starfield</option>
          </select>
          <label class="block"><i class="fas fa-shapes mr-2"></i> Particle Effect</label>
          <select id="particleType" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="circle">Circle</option>
            <option value="star">Star</option>
            <option value="triangle">Triangle</option>
            <option value="edge">Edge</option>
            <option value="nebula-cloud">Nebula Cloud</option>
            <option value="cosmic-dust">Cosmic Dust</option>
          </select>
          <label class="block"><i class="fas fa-tachometer-alt mr-2"></i> Particle Density</label>
          <input id="particleDensity" type="range" min="50" max="300" value="120" class="w-full">
          <label class="block"><i class="fas fa-tachometer-alt mr-2"></i> Particle Speed</label>
          <input id="particleSpeed" type="range" min="2" max="15" value="4" class="w-full">
          <label class="block"><i class="fas fa-palette mr-2"></i> Particle Color</label>
          <input id="particleColor" type="color" value="#4b6cb7" class="w-full h-10 border border-gray-600 rounded-lg bg-gray-700">
          <label class="block"><i class="fas fa-adjust mr-2"></i> Background Opacity</label>
          <input id="bgOpacity" type="range" min="0.3" max="1" step="0.1" value="0.6" class="w-full">
          <label class="block"><i class="fas fa-bolt mr-2"></i> Animation Intensity</label>
          <input id="animIntensity" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full">
          <label class="block"><i class="fas fa-redo mr-2"></i> Proxy Retry Attempts</label>
          <input id="proxyRetries" type="number" min="1" max="5" value="2" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
          <label class="flex items-center">
            <input id="ambientSound" type="checkbox" class="mr-2">
            <span><i class="fas fa-volume-up mr-2"></i> Enable Ambient Sound</span>
          </label>
          <label class="block"><i class="fas fa-server mr-2"></i> Proxy Server</label>
          <select id="proxySelect" class="w-full border border-gray-600 p-2 rounded-lg bg-gray-700 text-gray-200">
            <option value="allorigins">AllOrigins</option>
            <option value="corsproxy">CORS Proxy</option>
          </select>
        </div>
      </div>
      <div id="favoritesPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-star mr-2"></i> Favorites</h2>
        <div id="favoritesList" class="space-y-2"></div>
      </div>
      <div id="aboutPanel" class="toggle-panel hidden">
        <h2 class="text-lg font-bold mb-4 text-blue-400"><i class="fas fa-info-circle mr-2"></i> About Emulation's Proxy</h2>
        <div class="space-y-4 text-gray-300">
          <p><strong>Emulation's Proxy</strong> is a cosmic-themed proxy website designed for seamless web access with a futuristic interface.</p>
          <ul class="list-disc pl-5">
            <li><strong>Proxy Access</strong>: Load websites via a proxy (allorigins.win or corsproxy.io) by entering a URL and clicking Go.</li>
            <li><strong>Tab Cloaking</strong>: Disguise the page title and favicon for privacy (customize in Settings).</li>
            <li><strong>Panic Button</strong>: Instantly redirect to a safe URL (default: YouTube) with the Escape key or Panic button.</li>
            <li><strong>Visuals</strong>: Enjoy Three.js animations and customizable particle effects (circle, star, triangle, edge, nebula-cloud, cosmic-dust).</li>
            <li><strong>3D View</strong>: Explore a 3D particle field with mouse controls.</li>
            <li><strong>Themes</strong>: Switch between Dark, Nebula, and Starfield themes.</li>
            <li><strong>Ambient Sound</strong>: Toggle space-themed audio inspired by <a href="https://www.youtube.com/watch?v=EAsEjQPio24" target="_blank" class="text-blue-400 hover:underline">this YouTube track</a>.</li>
            <li><strong>Socials</strong>: Connect with us on <a href="https://www.youtube.com/@Emulation12" target="_blank" class="text-blue-400 hover:underline"><i class="fab fa-youtube mr-1"></i> YouTube (@Emulation12)</a>.</li>
          </ul>
          <p>Explore the cosmos while browsing securely!</p>
        </div>
      </div>
    </div>
    <div class="relative rounded-lg overflow-hidden">
      <div id="loader" class="loader">
        <svg width="64" height="64" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd" stroke-width="2">
            <circle cx="22" cy="22" r="20" stroke="#4b6cb7" stroke-opacity=".3"/>
            <circle cx="22" cy="22" r="20" stroke="#9f7aea" stroke-dasharray="90" stroke-dashoffset="60">
              <animateTransform attributeName="transform" type="rotate" from="0 22 22" to="360 22 22" dur="1s" repeatCount="indefinite"/>
            </circle>
          </g>
        </svg>
      </div>
      <iframe id="contentFrame" class="w-full h-[700px] border-0"></iframe>
    </div>
    <div id="notification" class="notification hidden fixed bottom-4 right-4 p-4 text-white"></div>
  </div>
  <!-- Space Ambience sound from Pixabay: https://pixabay.com/sound-effects/ambient-space-174687/ by cybercut, CC0 -->
  <audio id="ambientAudio" loop>
    <source src="https://cdn.pixabay.com/audio/2024/03/20/14-08-49-773_174687.mp3" type="audio/mpeg">
  </audio>
  <script>
    // Sanitize string to prevent injection
    function sanitize(str) {
      return DOMPurify.sanitize(str, { USE_PROFILES: { html: true } });
    }

    // Initialize particles.js
    function initParticles(theme, density = 120, speed = 4, type = 'circle', color = '#4b6cb7') {
      const baseConfig = {
        particles: {
          number: { value: density, density: { enable: true, value_area: 1000 } },
          color: { value: color },
          shape: { type },
          opacity: { value: 0.6, random: true },
          size: { value: 3, random: true },
          line_linked: { enable: true, distance: 100, color, opacity: 0.4, width: 1 },
          move: { enable: true, speed, direction: 'none', random: true }
        },
        interactivity: {
          detect_on: 'canvas',
          events: { onhover: { enable: true, mode: 'grab' }, onclick: { enable: true, mode: 'push' } },
          modes: { grab: { distance: 150, line_linked: { opacity: 0.7 } }, push: { particles_nb: 4 } }
        },
        retina_detect: true
      };
      const configs = {
        dark: baseConfig,
        nebula: {
          ...baseConfig,
          particles: { ...baseConfig.particles, opacity: { value: 0.7 }, size: { value: 4 }, line_linked: { distance: 150, opacity: 0.5, width: 1.5 } },
          interactivity: { ...baseConfig.interactivity, events: { onhover: { mode: 'bubble' }, onclick: { mode: 'repulse' } }, modes: { bubble: { distance: 200, size: 5, duration: 2 }, repulse: { distance: 100 } } }
        },
        starfield: {
          ...baseConfig,
          particles: { ...baseConfig.particles, opacity: { value: 0.8 }, size: { value: 2 }, line_linked: { enable: false }, move: { direction: 'random' } }
        },
        'nebula-cloud': {
          ...baseConfig,
          particles: { ...baseConfig.particles, number: { value: density / 2, density: { value_area: 1500 } }, opacity: { value: 0.5 }, size: { value: 5 }, line_linked: { distance: 200, opacity: 0.3, width: 2 }, move: { speed: speed / 2, attract: { enable: true, rotateX: 600, rotateY: 1200 } } },
          interactivity: { ...baseConfig.interactivity, modes: { bubble: { distance: 300, size: 8, duration: 3 }, push: { particles_nb: 2 } } }
        },
        'cosmic-dust': {
          ...baseConfig,
          particles: { ...baseConfig.particles, number: { value: density / 3, density: { value_area: 2000 } }, opacity: { value: 0.4, anim: { enable: true, speed: 1, opacity_min: 0.1 } }, size: { value: 2 }, line_linked: { enable: false }, move: { speed: speed / 3, direction: 'random' } },
          interactivity: { ...baseConfig.interactivity, modes: { repulse: { distance: 150 }, push: { particles_nb: 3 } } }
        }
      };
      particlesJS('particles-js', configs[theme] || baseConfig);
    }

    // Initialize Three.js
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.position.z = 50;

    // Black hole
    const discGeometry = new THREE.RingGeometry(5, 15, 32);
    const discMaterial = new THREE.MeshBasicMaterial({ color: 0x0a0a0a, side: THREE.DoubleSide });
    const blackHole = new THREE.Mesh(discGeometry, discMaterial);
    scene.add(blackHole);
    gsap.to(blackHole.rotation, { z: '+=6.28', duration: 10, repeat: -1, ease: 'linear' });

    // Planets and asteroids
    const objects = [];
    for (let i = 0; i < 8; i++) {
      const isPlanet = i < 4;
      const geometry = new THREE.SphereGeometry(isPlanet ? 1 + Math.random() * 2 : 0.5 + Math.random(), 32, 32);
      const material = new THREE.MeshBasicMaterial({ color: ['#4b6cb7', '#9f7aea', '#ff6b6b', '#00cc99', '#ffcc00', '#66ffcc', '#ff3399', '#33ccff'][i] });
      const obj = new THREE.Mesh(geometry, material);
      obj.position.set((Math.random() - 0.5) * 40, (Math.random() - 0.5) * 20, isPlanet ? -10 : -15);
      scene.add(obj);
      objects.push(obj);
      gsap.to(obj.position, { x: `+=${10 + Math.random() * 20}`, duration: isPlanet ? 5 + Math.random() * 5 : 3 + Math.random() * 3, repeat: -1, yoyo: true, ease: 'sine.inOut' });
    }

    // 3D Particle field
    const particleGeometry = new THREE.BufferGeometry();
    const particleVertices = [];
    const particleColors = [];
    const colors = [0x4b6cb7, 0x9f7aea, 0xff6b6b, 0x00cc99];
    for (let i = 0; i < 5000; i++) {
      particleVertices.push((Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200);
      const color = new THREE.Color(colors[Math.floor(Math.random() * colors.length)]);
      particleColors.push(color.r, color.g, color.b);
    }
    particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(particleVertices, 3));
    particleGeometry.setAttribute('color', new THREE.Float32BufferAttribute(particleColors, 3));
    const particleMaterial = new THREE.PointsMaterial({ size: 0.3, vertexColors: true, transparent: true, opacity: 0.8 });
    const particles = new THREE.Points(particleGeometry, particleMaterial);
    let particleViewActive = false;

    // OrbitControls for 3D view
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enabled = false;
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.rotateSpeed = 0.5;

    // Animation loop
    function animateThree() {
      requestAnimationFrame(animateThree);
      if (particleViewActive) {
        particles.rotation.y += 0.001;
        controls.update();
      } else {
        objects.forEach(obj => obj.rotation.y += 0.002);
      }
      renderer.render(scene, camera);
    }
    animateThree();

    // Resize handler
    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });

    // DOM elements
    const urlInput = document.getElementById('urlInput');
    const submitBtn = document.getElementById('submitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const addFavoriteBtn = document.getElementById('addFavoriteBtn');
    const cloakBtn = document.getElementById('cloakBtn');
    const panicBtn = document.getElementById('panicBtn');
    const errorDiv = document.getElementById('error');
    const contentFrame = document.getElementById('contentFrame');
    const tabsDiv = document.getElementById('tabs');
    const settingsPanel = document.getElementById('settingsPanel');
    const favoritesPanel = document.getElementById('favoritesPanel');
    const aboutPanel = document.getElementById('aboutPanel');
    const settingsBtn = document.getElementById('settingsBtn');
    const favoritesBtn = document.getElementById('favoritesBtn');
    const aboutBtn = document.getElementById('aboutBtn');
    const particleViewBtn = document.getElementById('particleViewBtn');
    const newTabBtn = document.getElementById('newTabBtn');
    const cloakToggle = document.getElementById('cloakToggle');
    const cloakTitle = document.getElementById('cloakTitle');
    const cloakFavicon = document.getElementById('cloakFavicon');
    const panicUrlInput = document.getElementById('panicUrl');
    const themeSelect = document.getElementById('themeSelect');
    const particleDensity = document.getElementById('particleDensity');
    const particleSpeed = document.getElementById('particleSpeed');
    const particleType = document.getElementById('particleType');
    const particleColor = document.getElementById('particleColor');
    const bgOpacity = document.getElementById('bgOpacity');
    const animIntensity = document.getElementById('animIntensity');
    const proxyRetries = document.getElementById('proxyRetries');
    const proxySelect = document.getElementById('proxySelect');
    const notification = document.getElementById('notification');
    const ambientAudio = document.getElementById('ambientAudio');
    const loader = document.getElementById('loader');
    let tabs = JSON.parse(localStorage.getItem('tabs')) || [
      { id: 'new-tab', url: null, content: `
        <div class="new-tab-content">
          <h2 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 typing-text">Welcome to Emulation's Proxy</h2>
          <p class="text-lg mb-6 text-gray-300">Embark on a cosmic journey through the web! Browse securely, save favorites, or explore a 3D particle universe.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('urlInput').focus()">
              <i class="fas fa-globe text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Browse</h3>
              <p class="text-gray-400">Access any website through our secure proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('favoritesBtn').click()">
              <i class="fas fa-star text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Favorites</h3>
              <p class="text-gray-400">Save and revisit your favorite sites instantly.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('settingsBtn').click()">
              <i class="fas fa-cog text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Settings</h3>
              <p class="text-gray-400">Customize themes, particles, and more!</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('particleViewBtn').click()">
              <i class="fas fa-cubes text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">3D View</h3>
              <p class="text-gray-400">Explore an interactive 3D particle field.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('aboutBtn').click()">
              <i class="fas fa-info-circle text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">About</h3>
              <p class="text-gray-400">Learn more about Emulation's Proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('panicBtn').click()">
              <i class="fas fa-ban text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Panic</h3>
              <p class="text-gray-400">Quickly redirect to a safe URL.</p>
            </div>
          </div>
        </div>`, label: 'New Tab', type: 'new-tab', icon: 'fas fa-home' }
    ];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

    // Theme management
    function applyTheme(theme) {
      const backgrounds = {
        dark: 'linear-gradient(180deg, #0a0a0a, #1a1a1a)',
        nebula: 'linear-gradient(180deg, #1a0033, #330066)',
        starfield: 'linear-gradient(180deg, #000000, #0a0a1a)'
      };
      document.body.style.background = backgrounds[theme];
      document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
      gsap.to('.btn-cosmic, .control-panel, .tab.active', { animationDuration: parseFloat(animIntensity.value) * 1.5, duration: 0.3 });
      initParticles(theme, parseInt(particleDensity.value), parseInt(particleSpeed.value), particleType.value, particleColor.value);
    }
    themeSelect.addEventListener('change', () => applyTheme(themeSelect.value));
    particleDensity.addEventListener('input', () => applyTheme(themeSelect.value));
    particleSpeed.addEventListener('input', () => applyTheme(themeSelect.value));
    particleType.addEventListener('change', () => applyTheme(themeSelect.value));
    particleColor.addEventListener('input', () => applyTheme(themeSelect.value));
    bgOpacity.addEventListener('input', () => applyTheme(themeSelect.value));
    animIntensity.addEventListener('input', () => applyTheme(themeSelect.value));
    applyTheme('dark');

    // Ambient sound toggle
    document.getElementById('ambientSound').addEventListener('change', (e) => {
      if (e.target.checked) {
        ambientAudio.play().catch(err => {
          errorDiv.textContent = `Failed to play ambient sound: ${err.message}`;
          errorDiv.classList.remove('hidden');
          gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        });
      } else {
        ambientAudio.pause();
      }
    });

    // Tab cloaking
    function updateCloaking() {
      if (cloakToggle.checked) {
        document.getElementById('pageTitle').textContent = cloakTitle.value || "Emulation's Proxy";
        document.getElementById('favicon').href = cloakFavicon.value || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9ImdyYWRpZW50IiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM0YjZjYjciIHN0b3Atb3BhY2l0eT0iMSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzE4Mjg0OCIgc3RvcC1vcGFjaXR5PSIwLjUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48cGF0aCBkPSJNNDggNTBhMjAgMjAgMCAxIDAgMCA0MCAyMCAyMCAwIDAgMCAwIC00MFoiIGZpbGw9IiNmZmZiNmIiIHN0cm9rZT0iIzlmN2FlYSIgc3Ryb2tlLXdpZHRoPSIxLjUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik01MCA1MGEzMCAzMCAwIDAgMCA0MiA0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1kYXNoYXJyYXk9IjMsMyIgb3BhY2l0eT0iMC41Ii8+PHBhdGggZD0iTTYwIDUwYTUgNSAwIDEgMCAwIDEwIDUgNSAwIDAgMCAwIC0xMFoiIGZpbGw9IiM5ZjdhZWEiLz48L3N2Zz4=';
      } else {
        document.getElementById('pageTitle').textContent = "Emulation's Proxy";
        document.getElementById('favicon').href = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9ImdyYWRpZW50IiBjeD0iNTAlIiBjeT0iNTAlIiByPSI1MCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM0YjZjYjciIHN0b3Atb3BhY2l0eT0iMSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzE4Mjg0OCIgc3RvcC1vcGFjaXR5PSIwLjUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48cGF0aCBkPSJNNDggNTBhMjAgMjAgMCAxIDAgMCA0MCAyMCAyMCAwIDAgMCAwIC00MFoiIGZpbGw9IiNmZmZiNmIiIHN0cm9rZT0iIzlmN2FlYSIgc3Ryb2tlLXdpZHRoPSIxLjUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik01MCA1MGEzMCAzMCAwIDAgMCA0MiA0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1kYXNoYXJyYXk9IjMsMyIgb3BhY2l0eT0iMC41Ii8+PHBhdGggZD0iTTYwIDUwYTUgNSAwIDEgMCAwIDEwIDUgNSAwIDAgMCAwIC0xMFoiIGZpbGw9IiM5ZjdhZWEiLz48L3N2Zz4=';
      }
    }
    cloakToggle.addEventListener('change', updateCloaking);
    cloakTitle.addEventListener('input', updateCloaking);
    cloakFavicon.addEventListener('input', updateCloaking);

    // Toggle panels
    function togglePanel(panel, button) {
      const isHidden = panel.classList.contains('hidden');
      [settingsPanel, favoritesPanel, aboutPanel].forEach(p => p.classList.add('hidden'));
      if (isHidden) {
        panel.classList.remove('hidden');
        gsap.fromTo(panel, { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.3 });
      }
    }
    settingsBtn.addEventListener('click', () => togglePanel(settingsPanel, settingsBtn));
    favoritesBtn.addEventListener('click', () => togglePanel(favoritesPanel, favoritesBtn));
    aboutBtn.addEventListener('click', () => togglePanel(aboutPanel, aboutBtn));

    // 3D Particle view toggle
    particleViewBtn.addEventListener('click', () => {
      particleViewActive = !particleViewActive;
      if (particleViewActive) {
        scene.add(particles);
        controls.enabled = true;
        document.querySelector('#three-canvas').style.opacity = 1;
        [settingsPanel, favoritesPanel, aboutPanel, contentFrame].forEach(el => el.classList.add('hidden'));
        particleViewBtn.innerHTML = '<i class="fas fa-times"></i> Exit 3D View';
        Swal.fire({
          title: '3D Particle View',
          text: 'Use mouse to rotate and scroll to zoom. Click again to exit.',
          icon: 'info',
          timer: 2000,
          showConfirmButton: false,
          background: '#1a1a1a',
          color: '#fff'
        });
      } else {
        scene.remove(particles);
        controls.enabled = false;
        document.querySelector('#three-canvas').style.opacity = parseFloat(bgOpacity.value);
        contentFrame.classList.remove('hidden');
        particleViewBtn.innerHTML = '<i class="fas fa-cubes"></i> 3D View';
        const activeTab = tabs.find(t => t.id === tabsDiv.dataset.active);
        contentFrame.srcdoc = activeTab ? activeTab.content : '';
      }
    });

    // Favorites management
    function renderFavorites() {
      const favoritesList = document.getElementById('favoritesList');
      favoritesList.innerHTML = '';
      favorites.forEach((fav, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-gray-800 p-2 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center">
            <img src="https://www.google.com/s2/favicons?domain=${sanitize(fav.url)}" class="w-5 h-5 mr-2" alt="Favicon">
            <a href="#" class="text-blue-400 hover:underline" data-url="${sanitize(fav.url)}">${sanitize(fav.label)}</a>
          </div>
          <button class="text-red-400" data-index="${index}"><i class="fas fa-trash"></i></button>
        `;
        div.querySelector('a').addEventListener('click', (e) => {
          e.preventDefault();
          urlInput.value = fav.url;
          submitBtn.click();
        });
        div.querySelector('button').addEventListener('click', () => {
          favorites.splice(index, 1);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          renderFavorites();
        });
        favoritesList.appendChild(div);
      });
    }
    addFavoriteBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      if (url && !favorites.some(f => f.url === url)) {
        const hostname = new URL(url.match(/^https?:\/\//) ? url : 'https://' + url).hostname;
        favorites.push({ url, label: hostname });
        localStorage.setItem('favorites', JSON.stringify(favorites));
        renderFavorites();
        Swal.fire({
          title: 'Added to Favorites',
          text: `${sanitize(hostname)} saved`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false,
          background: '#1a1a1a',
          color: '#fff'
        });
      }
    });
    renderFavorites();

    // Add tab
    function addTab(id, url, content, label, type = 'proxy', icon = 'fas fa-globe') {
      tabs = tabs.filter(t => t.url !== url || t.type !== 'proxy');
      tabs.push({ id, url, content, label, type, icon });
      localStorage.setItem('tabs', JSON.stringify(tabs));
      renderTabs();
    }

    // Render tabs
    function renderTabs() {
      tabsDiv.innerHTML = '';
      tabs.forEach(tab => {
        const tabBtn = document.createElement('button');
        tabBtn.className = `tab text-gray-200 px-4 py-2 rounded-lg ${tab.id === tabsDiv.dataset.active ? 'active' : ''}`;
        tabBtn.setAttribute('role', 'tab');
        tabBtn.setAttribute('aria-selected', tab.id === tabsDiv.dataset.active);
        tabBtn.innerHTML = tab.icon.startsWith('<img') ? `${tab.icon}${sanitize(tab.label)}` : `<i class="${tab.icon} mr-2"></i>${sanitize(tab.label)}`;
        const closeBtn = document.createElement('span');
        closeBtn.textContent = ' ×';
        closeBtn.className = 'ml-2 text-red-400 cursor-pointer';
        closeBtn.setAttribute('aria-label', `Close ${tab.label}`);
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          tabs = tabs.filter(t => t.id !== tab.id);
          localStorage.setItem('tabs', JSON.stringify(tabs));
          if (tab.id === tabsDiv.dataset.active) {
            tabsDiv.dataset.active = 'new-tab';
            const newTab = tabs.find(t => t.id === 'new-tab');
            contentFrame.srcdoc = newTab ? newTab.content : '';
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          }
          renderTabs();
        };
        tabBtn.appendChild(closeBtn);
        tabBtn.onclick = () => {
          tabsDiv.dataset.active = tab.id;
          const favicon = document.getElementById('favicon');
          favicon.href = tab.icon.startsWith('<img') ? tab.icon.match(/src="([^"]+)"/)[1] : favicon.href;
          if (tab.type === 'proxy' && tab.content) {
            contentFrame.srcdoc = tab.content;
            contentFrame.classList.remove('hidden');
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          } else if (tab.type === 'new-tab') {
            contentFrame.srcdoc = tab.content;
            contentFrame.classList.remove('hidden');
            settingsPanel.classList.add('hidden');
            favoritesPanel.classList.add('hidden');
            aboutPanel.classList.add('hidden');
          }
          renderTabs();
          anime({
            targets: tabBtn,
            scale: [0.9, 1],
            duration: 300,
            easing: 'easeOutQuad'
          });
        };
        tabsDiv.appendChild(tabBtn);
        if (tab.id === tabsDiv.dataset.active) {
          tabBtn.classList.add('active');
          anime({
            targets: tabBtn,
            scale: [0.9, 1],
            duration: 300,
            easing: 'easeOutQuad'
          });
        }
      });
    }
    tabsDiv.dataset.active = 'new-tab';
    contentFrame.srcdoc = tabs.find(t => t.id === 'new-tab').content;
    renderTabs();

    // New tab button
    newTabBtn.addEventListener('click', () => {
      addTab(Date.now().toString(), null, `
        <div class="new-tab-content">
          <h2 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 typing-text">Welcome to Emulation's Proxy</h2>
          <p class="text-lg mb-6 text-gray-300">Embark on a cosmic journey through the web! Browse securely, save favorites, or explore a 3D particle universe.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('urlInput').focus()">
              <i class="fas fa-globe text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Browse</h3>
              <p class="text-gray-400">Access any website through our secure proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('favoritesBtn').click()">
              <i class="fas fa-star text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Favorites</h3>
              <p class="text-gray-400">Save and revisit your favorite sites instantly.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('settingsBtn').click()">
              <i class="fas fa-cog text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Settings</h3>
              <p class="text-gray-400">Customize themes, particles, and more!</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('particleViewBtn').click()">
              <i class="fas fa-cubes text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">3D View</h3>
              <p class="text-gray-400">Explore an interactive 3D particle field.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('aboutBtn').click()">
              <i class="fas fa-info-circle text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">About</h3>
              <p class="text-gray-400">Learn more about Emulation's Proxy.</p>
            </div>
            <div class="card p-6 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="document.getElementById('panicBtn').click()">
              <i class="fas fa-ban text-3xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold">Panic</h3>
              <p class="text-gray-400">Quickly redirect to a safe URL.</p>
            </div>
          </div>
        </div>`, 'New Tab', 'new-tab', 'fas fa-home');
      tabsDiv.dataset.active = Date.now().toString();
      renderTabs();
    });

    // About:Blank cloaking
    cloakBtn.addEventListener('click', () => {
      try {
        const currentContent = encodeURIComponent(contentFrame.srcdoc || '');
        if (currentContent) {
          const cloakFrame = document.createElement('iframe');
          cloakFrame.srcdoc = `
            <!DOCTYPE html>
            <html>
              <head><title>${sanitize(cloakToggle.checked ? cloakTitle.value : "Emulation's Proxy")}</title></head>
              <body style="margin:0;overflow:hidden;">
                <iframe srcdoc="${currentContent}" style="width:100%;height:100vh;border:0;"></iframe>
              </body>
            </html>
          `;
          cloakFrame.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;border:0;z-index:1000;';
          document.body.appendChild(cloakFrame);
          Swal.fire({
            title: 'Success',
            text: 'Content opened in About:Blank',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false,
            background: '#1a1a1a',
            color: '#fff'
          });
        } else {
          errorDiv.textContent = 'No content to cloak';
          errorDiv.classList.remove('hidden');
          gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        }
      } catch (err) {
        errorDiv.textContent = `Failed to open About:Blank: ${err.message}`;
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
      }
    });

    // Panic button
    function triggerPanic() {
      window.location.href = panicUrlInput.value || 'https://www.youtube.com/@Emulation12';
    }
    panicBtn.addEventListener('click', triggerPanic);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') triggerPanic();
    });

    // Full screen
    fullscreenBtn.addEventListener('click', () => {
      if (contentFrame.requestFullscreen) {
        contentFrame.requestFullscreen();
      } else if (contentFrame.webkitRequestFullscreen) {
        contentFrame.webkitRequestFullscreen();
      } else if (contentFrame.msRequestFullscreen) {
        contentFrame.msRequestFullscreen();
      }
      Swal.fire({
        title: 'Full Screen',
        text: 'Entered full-screen mode',
        icon: 'info',
        timer: 1500,
        showConfirmButton: false,
        background: '#1a1a1a',
        color: '#fff'
      });
    });

    // Handle proxy request
    async function fetchWithRetries(url, retries) {
      const proxyUrls = {
        allorigins: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        corsproxy: `https://corsproxy.io/?${encodeURIComponent(url)}`
      };
      const selectedProxy = proxySelect.value;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(proxyUrls[selectedProxy]);
          if (response.ok) return response;
          if (response.status === 429) {
            throw new Error('Rate limit exceeded. Please try again later.');
          }
          throw new Error(`HTTP error ${response.status}`);
        } catch (err) {
          if (i === retries - 1) throw err;
        }
      }
    }
    submitBtn.addEventListener('click', async () => {
      let url = urlInput.value.trim();
      errorDiv.classList.add('hidden');
      contentFrame.classList.add('hidden');
      settingsPanel.classList.add('hidden');
      favoritesPanel.classList.add('hidden');
      aboutPanel.classList.add('hidden');
      loader.style.display = 'block';

      if (!url) {
        errorDiv.textContent = 'Please enter a URL';
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        loader.style.display = 'none';
        return;
      }

      if (!url.match(/^https?:\/\//)) {
        url = 'https://' + url;
      }
      if (!url.match(/^https?:\/\/.+/)) {
        errorDiv.textContent = 'Invalid URL format';
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        loader.style.display = 'none';
        return;
      }

      const hostname = new URL(url).hostname;
      notification.textContent = `Going to ${sanitize(hostname)}`;
      notification.classList.remove('hidden');
      gsap.fromTo(notification, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
      gsap.to(notification, { opacity: 0, delay: 2, duration: 0.5, onComplete: () => notification.classList.add('hidden') });

      const tabId = Date.now().toString();
      tabsDiv.dataset.active = tabId;
      const tabBtn = document.createElement('button');
      tabBtn.className = 'tab text-gray-200 px-4 py-2 rounded-lg loading';
      tabBtn.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${hostname}" class="w-5 h-5 mr-2" alt="Favicon">${sanitize(hostname)}`;
      tabsDiv.appendChild(tabBtn);
      anime({
        targets: tabBtn,
        scale: [0.9, 1],
        duration: 300,
        easing: 'easeOutQuad'
      });

      try {
        const response = await fetchWithRetries(url, parseInt(proxyRetries.value));
        const data = await response.text();
        contentFrame.srcdoc = data;
        contentFrame.classList.remove('hidden');
        addTab(tabId, url, data, hostname, 'proxy', `<img src="https://www.google.com/s2/favicons?domain=${hostname}" class="w-5 h-5" alt="Favicon">`);
        anime({
          targets: contentFrame,
          opacity: [0, 1],
          scale: [0.95, 1],
          duration: 500,
          easing: 'easeOutQuad'
        });
        Swal.fire({
          title: 'Success',
          text: `Loaded ${sanitize(hostname)}`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false,
          background: '#1a1a1a',
          color: '#fff'
        });
      } catch (err) {
        let message = 'Failed to load URL. Try another proxy or URL.';
        if (err.message.includes('429')) {
          message = 'Rate limit exceeded. Try again later or switch proxy.';
        } else if (err.message.includes('HTTP error')) {
          message = `HTTP error: ${err.message}. Check the URL or proxy settings.`;
        }
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        gsap.from(errorDiv, { opacity: 0, y: 10, duration: 0.5 });
        tabs = tabs.filter(t => t.id !== tabId);
        renderTabs();
        Swal.fire({
          title: 'Error',
          text: message,
          icon: 'error',
          timer: 2000,
          showConfirmButton: false,
          background: '#1a1a1a',
          color: '#fff'
        });
      } finally {
        loader.style.display = 'none';
      }
    });

    // Keyboard shortcuts
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitBtn.click();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        const currentIndex = tabs.findIndex(t => t.id === tabsDiv.dataset.active);
        const nextIndex = e.key === 'ArrowRight' ? (currentIndex + 1) % tabs.length : (currentIndex - 1 + tabs.length) % tabs.length;
        tabsDiv.dataset.active = tabs[nextIndex].id;
        tabsDiv.querySelectorAll('.tab')[nextIndex].click();
      }
    });

    // Initialize particles
    initParticles('dark');
  </script>
</body>
</html>
